# oh-archiver
Архивирование хранимых данных OpenHab на уровне отдельных Items

Читайте также на других языках: [English](README.md), [Deutsch](README.de.md), [Русский](README.ru.md) 

> [!NOTE]
> На данный момент поддерживается только InfluxDB v2


Проеет имеет целью реализацию гибкого архивирования хранимых данных items в OpenHab. Под архивированием понимается регулярное изъятие части данных из БД и обеспечение их хранения в долгосрочной перспективе в неизменном виде.

Процедура архивирования следующая:
* В OpenHab
  - Cоздаются группы вида G_Ret_<NN>M|Y, где <NN> - это число, M обозначает "месяц" и Y - "год". Комбинация <NN>M|Y задает период архивирования. Например, G_Ret_6M, или G_Ret_1Y.
  - Каждый item, данные которого требуется архивировать, помещается в одну из групп G_Ret_XXX
  - Ежедневно по расписанию запускается скрипт updateItemsMetadata, который раз в сутки пробегает по items и добавляет в метаданные influxdb тег RetDate, содержащий дату архивирования, округленную до месяца. Дата рассчитывается как сегодня + период из имени группы G_Ret_XXX. Например, если скрипт выполняется 25.03.2024 г, то в RetDate будет записано 09.2024 для G_Ret_6M и 03.2025 для G_Ret_1Y. Таким образом все записи в InfluxDB будут содержать актуальную дату архивирования в теге RetDate.
* На сервере InfluxDB ежемесячно по расписанию запускается скрипт retire_measurements.sh, который:
  - Выбирает из БД записи (points), для которых значение тега RetDate равно текущему месяцу и году
  - Раскладывает записи в виде csv-строк в файлы, группируя их по измерению (measurement), месяцу и году. Другими словами, записи для измерения "KitchenTemperature", созданные в течении марта 2023 г, попадут в файл append.KitchenTemperature.2023-03.csv, в апреле - в append.KitchenTemperature.2023-04.csv и т.д.
  - Сжимает файлы и отсылает их на Rsync-сервер (сервер ведения архива)
  - Удаляет выбранные данные из БД

Главные достоинства такого подхода:
* Простота использования - достаточно поместить item в соответствующую группу G_Ret_XXX
* Решается проблема постоянного роста размеры БД на диске, так как данные периодически удаляются
* Архивные данные остаются в неизменном виде (без усреднения и прочих преобразований)
* Архивные данные в виде отдельных csv-файлов, что дает возможность их анализа практически в любом ПО
